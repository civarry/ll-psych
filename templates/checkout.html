{% extends 'base.html' %}

{% block title %}Checkout - {{ exam.title }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-lg-8 offset-lg-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3>Payment Options for {{ exam.title }}</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h4>Payment Summary</h4>
                        <p><strong>Exam:</strong> {{ exam.title }}</p>
                        <p><strong>Amount:</strong> PHP {{ "%.2f"|format(exam.price) }}</p>
                        <p><strong>Email:</strong> {{ purchase.email }}</p>
                    </div>

                    <div class="payment-options">
                        <h4 class="mb-4">Choose Your Payment Method</h4>
                        
                        <div class="row">
                            <!-- Credit/Debit Card Option -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h5>Credit/Debit Card</h5>
                                    </div>
                                    <div class="card-body">
                                        <img src="https://www.paymongo.com/img/home/logos/visa.svg" alt="Visa" class="payment-icon" style="height: 30px;">
                                        <img src="https://www.paymongo.com/img/home/logos/mastercard.svg" alt="Mastercard" class="payment-icon" style="height: 30px;">
                                        
                                        <div class="mt-3">
                                            <button id="cardPaymentBtn" class="btn btn-primary btn-block">Pay with Card</button>
                                        </div>
                                        
                                        <!-- Card payment form (will be shown when card option is selected) -->
                                        <div id="cardForm" class="mt-3" style="display: none;">
                                            <div class="mb-3">
                                                <label for="cardNumber" class="form-label">Card Number</label>
                                                <input type="text" class="form-control" id="cardNumber" placeholder="4343434343434345">
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="expiryDate" class="form-label">Expiry Date</label>
                                                    <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="cvc" class="form-label">CVC</label>
                                                    <input type="text" class="form-control" id="cvc" placeholder="123">
                                                </div>
                                            </div>
                                            <button id="submitCardPayment" class="btn btn-success btn-block">Pay Now</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- E-Wallet Options -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-light">
                                        <h5>E-Wallets</h5>
                                    </div>
                                    <div class="card-body">
                                        <form action="{{ url_for('payment.create_source', purchase_id=purchase.id) }}" method="post">
                                            <div class="mb-3">
                                                <button type="submit" name="type" value="gcash" class="btn btn-info btn-block mb-2">
                                                    <img src="https://www.gcash.com/wp-content/uploads/2019/04/gcash-logo.png" alt="GCash" style="height: 20px; margin-right: 5px;">
                                                    Pay with GCash
                                                </button>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <button type="submit" name="type" value="paymaya" class="btn btn-secondary btn-block">
                                                    <img src="https://www.paymaya.com/assets/images/paymaya-logo.svg" alt="PayMaya" style="height: 20px; margin-right: 5px;">
                                                    Pay with Maya
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- For testing in development - Using debug variable -->
                        {% if debug %}
                        <div class="mt-4">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h5>Test Payment (Development Only)</h5>
                                </div>
                                <div class="card-body">
                                    <form action="{{ url_for('payment.process_payment', purchase_id=purchase.id) }}" method="post">
                                        <button type="submit" class="btn btn-warning">Process Test Payment</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('main.shop') }}" class="btn btn-outline-secondary">Cancel</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PayMongo JavaScript for card payments -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cardPaymentBtn = document.getElementById('cardPaymentBtn');
        const cardForm = document.getElementById('cardForm');
        const submitCardPayment = document.getElementById('submitCardPayment');
        
        // Show card form when card payment is selected
        cardPaymentBtn.addEventListener('click', function() {
            cardPaymentBtn.style.display = 'none';
            cardForm.style.display = 'block';
        });
        
        // Handle card payment submission
        submitCardPayment.addEventListener('click', function() {
            const cardNumber = document.getElementById('cardNumber').value;
            const expiryDate = document.getElementById('expiryDate').value;
            const cvc = document.getElementById('cvc').value;
            
            if (!cardNumber || !expiryDate || !cvc) {
                alert('Please fill in all card details');
                return;
            }
            
            // Extract month and year from expiry date (MM/YY format)
            const [expMonth, expYear] = expiryDate.split('/');
            
            // Create payment intent first
            fetch('{{ url_for("payment.create_payment_intent", purchase_id=purchase.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                
                const clientKey = '{{ public_key }}';
                const paymentIntentId = data.id;
                
                // Here you would normally use PayMongo's SDK to attach payment method
                // For test implementation, we'll just redirect to success
                alert('In production, this would process the payment with PayMongo. Redirecting to success page for testing.');
                window.location.href = '{{ url_for("payment.success", purchase_id=purchase.id) }}';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was an error processing your payment. Please try again.');
            });
        });
    });
</script>
{% endblock %}